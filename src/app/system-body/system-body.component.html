<div class="body-container" [ngClass]="styleClass">
    <div class="body-title">
        <div class="title-left">
            <b>{{ body.bodyData.name }}</b>
            <span *ngIf="body.bodyData.subType">-</span>
            <span *ngIf="body.bodyData.subType" [matTooltip]="getSolidCompositionTooltip()"
                matTooltipClass="multiline-tooltip">{{ body.bodyData.subType }}</span>
            <span *ngIf="classifyNeutronStar()"
                [class]="classifyNeutronStar()!.classification === 'Anomalous' ? 'badge badge-red' : 'neutron-star-classification'"
                [matTooltip]="classifyNeutronStar()!.tooltip">{{ classifyNeutronStar()!.classification === 'Anomalous' ?
                classifyNeutronStar()!.classification : '- ' + classifyNeutronStar()!.classification }}</span>
            <span *ngIf="body.bodyData.atmosphereType || body.bodyData.atmosphereComposition"
                [matTooltip]="getAtmosphereCompositionTooltip()" matTooltipClass="multiline-tooltip"
                class="atmosphere-type">
                - {{ getAtmosphereDisplay() }}
            </span>
            <span *ngIf="isRingNotVisible()" class="badge badge-red clickable"
                (click)="showInvisibleRingExplanation()">Invisible</span>
            <span *ngIf="getHillLimitExceeded() && body.bodyData.type === 'Ring'" class="badge badge-red clickable"
                [matTooltip]="'Hill limit exceeded by ' + (getHillLimitExceeded()! | number:'0.0-0') + ' km'"
                (click)="showHillLimitExplanation()">Anomalous</span>
            <span *ngIf="isActualShepherd()" class="badge badge-blue clickable"
                [matTooltip]="'Shepherd moon (Hill sphere close to ring edge) - click for analysis'"
                (click)="showShepherdingHillLimitChart()">Shepherd</span>
            <span *ngIf="body.bodyData.isLandable" [class]="'badge ' + getLandableBadgeClass()"
                [matTooltip]="getLandableTooltip()">
                <img src="assets/icons/footprint.svg" style="width: 12px; height: 12px; filter: brightness(0);" />
            </span>
            <span *ngIf="getSpinResonance() !== 'none' || body.bodyData.rotationalPeriodTidallyLocked"
                class="badge badge-purple clickable" [matTooltip]="getSpinResonanceTooltip()"
                (click)="showTidalLockDialog()">
                <span *ngIf="getSpinResonance() !== 'none'">{{ getSpinResonance() }}</span>
                <fa-icon *ngIf="body.bodyData.rotationalPeriodTidallyLocked" [icon]="faLock" class="lock-icon"
                    [matTooltip]="'Click for tidal locking explanation'"></fa-icon>
            </span>
            <span
                *ngIf="body.bodyData.isLandable &&  body.bodyData.atmosphereType && body.bodyData.atmosphereType != ''"
                class="badge badge-blue">Odyssey</span>
            <span *ngIf="body.bodyData.terraformingState == 'Terraformable'"
                class="badge badge-gray">Terraformable</span>
            <span *ngIf="trojanStatus" class="badge badge-blue" [matTooltip]="'Trojan at Lagrange ' + trojanStatus">{{
                trojanStatus }}</span>
            <span *ngIf="rosetteStatus" class="badge badge-red" [matTooltip]="'Klemperer ' + rosetteStatus">{{
                rosetteStatus }}</span>
            <span *ngIf="getRocheExcess()" class="badge badge-red"
                [matTooltip]="'Roche limit exceeded by ' + (getRocheExcess()! | number:'0.0-0') + ' km'">
                <img src="assets/icons/roche.svg" style="width: 12px; height: 12px; filter: brightness(0);" />
            </span>
            <div *ngIf="geologySignals.length || geologySignalCount" matTooltip="Geological signals">
                <img src="assets/icons/Geology.png" />
            </div>
            <div *ngIf="biologySignals.length || biologySignalCount" matTooltip="Biological signals">
                <img src="assets/icons/Biology.png" />
            </div>
            <div *ngIf="thargoidSignals.length || thargoidSignalCount" matTooltip="Thargoid signals">
                <img src="assets/icons/Thargoid.png" />
            </div>
            <div *ngIf="guardianSignals.length || guardianSignalCount" matTooltip="Guardian signals">
                <img src="assets/icons/Guardian.png" />
            </div>
            <div *ngIf="humanSignalCount" matTooltip="Human signals">
                <img src="assets/icons/Human.png" />
            </div>
            <div *ngIf="body.bodyData.type === 'Ring' && getRingResourceTypes().has('Gemstone')"
                matTooltip="Contains gemstones">
                <span style="font-size: 16px;">üíé</span>
            </div>
            <div *ngIf="body.bodyData.type === 'Ring' && getRingResourceTypes().has('Metal')"
                matTooltip="Contains metals">
                <span style="font-size: 16px;">‚öôÔ∏è</span>
            </div>
            <div *ngIf="body.bodyData.type === 'Ring' && getRingResourceTypes().has('Mineral')"
                matTooltip="Contains minerals">
                <span style="font-size: 16px;">ü™®</span>
            </div>
            <div *ngIf="body.bodyData.type === 'Ring' && getRingResourceTypes().has('Fuel')" matTooltip="Contains fuel">
                <span style="font-size: 16px;">‚ö°</span>
            </div>
            <div *ngIf="exandable && !expanded" (click)="toggleExpand()" class="clickable" matTooltip="Expand">
                <fa-icon [icon]="faSquareCaretDown"></fa-icon>
            </div>
            <div *ngIf="exandable && expanded" (click)="toggleExpand()" class="clickable" matTooltip="Collapse">
                <fa-icon [icon]="faSquareCaretUp"></fa-icon>
            </div>
            <div *ngIf="hasChildren() && getChildrenExpandedState()" (click)="toggleChildren()" class="clickable"
                matTooltip="Collapse all children">
                <fa-icon [icon]="faSquareCaretUp"></fa-icon>
            </div>
            <div *ngIf="hasChildren() && !getChildrenExpandedState()" (click)="toggleChildren()" class="clickable"
                matTooltip="Expand all children">
                <fa-icon [icon]="faSquareCaretDown"></fa-icon>
            </div>
        </div>
        <div class="materials-badges" (mouseleave)="hoveredIndex = -1">
            <span *ngFor="let material of getMaterialBadges(); let i = index" [class]="'badge ' + material.class"
                (mouseenter)="onMouseEnter(i)">{{ hoveredIndex === i ? material.tooltip : material.name }}</span>
            <button class="json-button" (click)="showBodyJsonDialog($event)"
                (contextmenu)="copyBodyJson(); $event.preventDefault()"
                matTooltip="View body JSON (right-click to copy)">
                <fa-icon [icon]="faCode"></fa-icon>
            </button>
        </div>
    </div>
    <div class="system-body" *ngIf="isExpanded" [@grow]>
        <div class="body-image">
            <img *ngIf="bodyCoronaImage" src="assets/{{ bodyCoronaImage }}" class="body-image-corona"
                (error)="bodyCoronaImage = ''" loading="lazy" />
            <img *ngIf="bodyImage" src="assets/{{ bodyImage }}" (error)="bodyImage = ''" loading="lazy" />
        </div>
        <div class="body-content">
            <div class="body-data-columns">
                <!-- Orbit Section -->
                <ng-container
                    *ngIf="body.bodyData.orbitalPeriod || body.bodyData.semiMajorAxis || body.bodyData.orbitalEccentricity !== undefined || body.bodyData.orbitalInclination || body.bodyData.argOfPeriapsis || body.bodyData.ascendingNode || getNextPeriapsis() || getNextApoapsis()">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Orbit</div>
                        <div *ngIf="body.bodyData.orbitalPeriod" class="body-data-entry">
                            <div>
                                Orbital period
                            </div>
                            <div [matTooltip]="body.bodyData.orbitalPeriod + ' days'">
                                {{ body.bodyData.orbitalPeriod | number:'0.2-2' }} days
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.semiMajorAxis" class="body-data-entry">
                            <div>
                                Semi-major axis
                            </div>
                            <div [matTooltip]="body.bodyData.semiMajorAxis + ' au'">
                                {{ (body.bodyData.semiMajorAxis * 149597870.7) | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.orbitalEccentricity !== undefined && body.bodyData.orbitalEccentricity !== null"
                            class="body-data-entry">
                            <div>
                                Orbital eccentricity
                            </div>
                            <div [matTooltip]="body.bodyData.orbitalEccentricity.toString()">
                                {{ body.bodyData.orbitalEccentricity | number:'0.4-4' }} {{
                                getEccentricityAnalysis(body.bodyData.orbitalEccentricity) }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.semiMajorAxis && body.bodyData.orbitalEccentricity !== undefined && body.bodyData.orbitalEccentricity !== null && body.bodyData.orbitalEccentricity !== 0"
                            class="body-data-entry">
                            <div>
                                Apoapsis
                            </div>
                            <div [matTooltip]="getApoapsis() + ' km'">
                                {{ getApoapsis() | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="getNextApoapsis()" class="body-data-entry">
                            <div>
                                Next apoapsis
                            </div>
                            <div>
                                {{ getNextApoapsis()!.date | date:'yyyy-MM-dd HH:mm' }} ({{ getNextApoapsis()!.days |
                                number:'0.1-1' }} days)
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.semiMajorAxis && body.bodyData.orbitalEccentricity !== undefined && body.bodyData.orbitalEccentricity !== null && body.bodyData.orbitalEccentricity !== 0"
                            class="body-data-entry">
                            <div>
                                Periapsis
                            </div>
                            <div [matTooltip]="getPeriapsis() + ' km'">
                                {{ getPeriapsis() | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="getNextPeriapsis()" class="body-data-entry">
                            <div>
                                Next periapsis
                            </div>
                            <div>
                                {{ getNextPeriapsis()!.date | date:'yyyy-MM-dd HH:mm' }} ({{ getNextPeriapsis()!.days |
                                number:'0.1-1' }} days)
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.orbitalInclination" class="body-data-entry">
                            <div>
                                Orbital inclination
                            </div>
                            <div [matTooltip]="body.bodyData.orbitalInclination + '¬∞'">
                                {{ body.bodyData.orbitalInclination | number:'0.2-2' }}¬∞
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.argOfPeriapsis" class="body-data-entry">
                            <div>
                                Argument of periapsis
                            </div>
                            <div [matTooltip]="body.bodyData.argOfPeriapsis + '¬∞'">
                                {{ body.bodyData.argOfPeriapsis | number:'0.2-2' }}¬∞
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.ascendingNode" class="body-data-entry">
                            <div>
                                Ascending node
                            </div>
                            <div [matTooltip]="body.bodyData.ascendingNode + '¬∞'">
                                {{ body.bodyData.ascendingNode | number:'0.2-2' }}¬∞
                            </div>
                        </div>
                        <div *ngIf="getTangentialVelocity() !== null" class="body-data-entry">
                            <div>
                                Tangential velocity
                            </div>
                            <div [matTooltip]="getTangentialVelocityTooltip()">
                                {{ getTangentialVelocityDisplay() }}
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Limits Section (Bodies only - when Roche limit breached or within parent rings) -->
                <ng-container *ngIf="calculateBodyRocheLimits() as rocheLimits">
                    <div class="body-data-section"
                        *ngIf="rocheLimits.periapsis < rocheLimits.rigid || rocheLimits.apoapsis < rocheLimits.fluid || isBodyWithinParentRings()">
                        <div class="body-data-section-header">Limits</div>
                        <div class="body-data-entry clickable" (click)="showBodyRocheLimitChart()">
                            <div>
                                Roche limit (rigid)
                            </div>
                            <div
                                [matTooltip]="'Rigid: ' + (rocheLimits.rigid | number:'0.0-0') + ' km, Periapsis: ' + (rocheLimits.periapsis | number:'0.0-0') + ' km' + (rocheLimits.periapsis < rocheLimits.rigid ? ' - BREACHED' : '')">
                                {{ rocheLimits.rigid | number:'0.2-2' }} km
                                <span *ngIf="rocheLimits.periapsis < rocheLimits.rigid" style="color: #ff6b6b;">‚ö†</span>
                                <span *ngIf="rocheLimits.periapsis >= rocheLimits.rigid"
                                    style="color: #51cf66;">‚úì</span>
                            </div>
                        </div>
                        <div class="body-data-entry clickable" (click)="showBodyRocheLimitChart()">
                            <div>
                                Roche limit (fluid)
                            </div>
                            <div
                                [matTooltip]="'Fluid: ' + (rocheLimits.fluid | number:'0.0-0') + ' km, Apoapsis: ' + (rocheLimits.apoapsis | number:'0.0-0') + ' km' + (rocheLimits.apoapsis < rocheLimits.fluid ? ' - BREACHED' : '')">
                                {{ rocheLimits.fluid | number:'0.2-2' }} km
                                <span *ngIf="rocheLimits.apoapsis < rocheLimits.fluid" style="color: #ff6b6b;">‚ö†</span>
                                <span *ngIf="rocheLimits.apoapsis >= rocheLimits.fluid" style="color: #51cf66;">‚úì</span>
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Hill Limit Section (for shepherding bodies) -->
                <ng-container *ngIf="calculateShepherdingHillLimit() as hillData">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Shepherding Analysis</div>
                        <div class="body-data-entry clickable" (click)="showShepherdingHillLimitChart()">
                            <div>
                                Hill sphere radius
                            </div>
                            <div
                                [matTooltip]="'Gravitational influence radius: ' + (hillData.hillRadius | number:'0.0-0') + ' km'">
                                {{ hillData.hillRadius | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div class="body-data-entry clickable" (click)="showShepherdingHillLimitChart()">
                            <div>
                                Position
                            </div>
                            <div>
                                <span *ngIf="hillData.withinRings"
                                    matTooltip="This body orbits within the parent's ring system">Within rings</span>
                                <span *ngIf="hillData.isFirstOutside"
                                    matTooltip="This is the first body outside the parent's ring system">First
                                    outside</span>
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Physical Properties Section -->
                <ng-container
                    *ngIf="body.bodyData.radius || body.bodyData.earthMasses || body.bodyData.solarMasses || body.bodyData.solarRadius || body.bodyData.gravity || body.bodyData.axialTilt || body.bodyData.age || body.bodyData.mass || (body.bodyData.innerRadius && body.bodyData.outerRadius)">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Physical Properties</div>
                        <div *ngIf="body.bodyData.radius" class="body-data-entry">
                            <div>
                                Radius
                            </div>
                            <div [matTooltip]="body.bodyData.radius + ' km'">
                                {{ body.bodyData.radius | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.solarRadius" class="body-data-entry">
                            <div>
                                Solar radius
                            </div>
                            <div [matTooltip]="body.bodyData.solarRadius.toString()">
                                {{ body.bodyData.solarRadius | number:'0.2-2' }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.earthMasses && body.bodyData.type === 'Planet'"
                            class="body-data-entry">
                            <div>
                                Mass
                            </div>
                            <div [matTooltip]="formattedEarthMass?.tooltip || ''">
                                {{ formattedEarthMass?.display }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.solarMasses" class="body-data-entry">
                            <div>
                                Solar masses
                            </div>
                            <div [matTooltip]="formattedSolarMass?.tooltip || ''">
                                {{ formattedSolarMass?.display }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.mass" class="body-data-entry">
                            <div>
                                Mass
                            </div>
                            <div [matTooltip]="body.bodyData.mass + ' Mt'">
                                {{ body.bodyData.mass | number:'0.2-2' }} Mt
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.gravity" class="body-data-entry">
                            <div>
                                Gravity
                            </div>
                            <div [matTooltip]="body.bodyData.gravity + ' G'">
                                {{ body.bodyData.gravity | number:'0.2-2' }} G
                            </div>
                        </div>
                        <div *ngIf="getPlanetaryDensity()" class="body-data-entry">
                            <div>
                                Density
                            </div>
                            <div [matTooltip]="getPlanetaryDensity()!.tooltip">
                                {{ getPlanetaryDensity()!.value | number:'0.2-2' }} {{ getPlanetaryDensity()!.unit }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.axialTilt" class="body-data-entry">
                            <div>
                                Axial tilt
                            </div>
                            <div [matTooltip]="body.bodyData.axialTilt + '¬∞'">
                                {{ body.bodyData.axialTilt | number:'0.2-2' }}¬∞
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.age" class="body-data-entry">
                            <div>
                                Age
                            </div>
                            <div>
                                {{ body.bodyData.age }} million years
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.innerRadius" class="body-data-entry">
                            <div>
                                Inner radius
                            </div>
                            <div [matTooltip]="body.bodyData.innerRadius + ' km'">
                                {{ body.bodyData.innerRadius | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.outerRadius" class="body-data-entry">
                            <div>
                                Outer radius
                            </div>
                            <div [matTooltip]="body.bodyData.outerRadius + ' km'">
                                {{ body.bodyData.outerRadius | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.innerRadius && body.bodyData.outerRadius" class="body-data-entry">
                            <div>
                                Ring width
                            </div>
                            <div [matTooltip]="getRingWidth() + ' km'">
                                {{ getRingWidth() | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.innerRadius && body.bodyData.outerRadius" class="body-data-entry">
                            <div>
                                Ring area
                            </div>
                            <div [matTooltip]="getRingArea() + ' km¬≤'">
                                {{ getRingArea() | number:'0.2-2' }} km¬≤
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.mass && body.bodyData.innerRadius && body.bodyData.outerRadius"
                            class="body-data-entry">
                            <div>
                                Density
                            </div>
                            <div [matTooltip]="getRingDensity() + ' Mt/km¬≤'">
                                {{ getRingDensity() | number:'0.2-2' }} Mt/km¬≤
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Limits Section (Rings only) -->
                <ng-container
                    *ngIf="body.bodyData.type === 'Ring' && (calculateRigidRocheLimit() !== null || calculateFluidRocheLimit() !== null)">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Limits</div>
                        <div *ngIf="calculateRigidRocheLimit() !== null" class="body-data-entry clickable"
                            (click)="showRocheLimitChart()">
                            <div>
                                Roche limit (rigid)
                            </div>
                            <div [matTooltip]="'Rigid body Roche limit: ' + calculateRigidRocheLimit()! + ' km'">
                                {{ calculateRigidRocheLimit()! | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="calculateFluidRocheLimit() !== null" class="body-data-entry clickable"
                            (click)="showRocheLimitChart()">
                            <div>
                                Roche limit (fluid)
                            </div>
                            <div [matTooltip]="'Fluid body Roche limit: ' + calculateFluidRocheLimit()! + ' km'">
                                {{ calculateFluidRocheLimit()! | number:'0.2-2' }} km
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Atmosphere & Environment Section -->
                <ng-container
                    *ngIf="body.bodyData.surfaceTemperature || body.bodyData.surfacePressure || body.bodyData.volcanismType">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Atmosphere & Environment</div>
                        <div *ngIf="body.bodyData.surfaceTemperature" class="body-data-entry">
                            <div>
                                Surface temperature
                            </div>
                            <div [matTooltip]="body.bodyData.surfaceTemperature + ' K'">
                                {{ body.bodyData.surfaceTemperature | number:'0.2-2' }} K
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.surfacePressure" class="body-data-entry">
                            <div>
                                Surface pressure
                            </div>
                            <div [matTooltip]="body.bodyData.surfacePressure + ' atmospheres'">
                                {{ body.bodyData.surfacePressure | number:'0.2-2' }} atmospheres
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.volcanismType" class="body-data-entry">
                            <div>
                                Volcanism
                            </div>
                            <div>
                                {{ body.bodyData.volcanismType }}
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Dynamics Section -->
                <ng-container *ngIf="body.bodyData.rotationalPeriod || body.bodyData.distanceToArrival !== undefined">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Dynamics</div>
                        <div *ngIf="body.bodyData.rotationalPeriod" class="body-data-entry">
                            <div>
                                Rotational period
                            </div>
                            <div [matTooltip]="body.bodyData.rotationalPeriod + ' days'">
                                {{ body.bodyData.rotationalPeriod | number:'0.2-2' }} days
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.distanceToArrival !== undefined && body.bodyData.distanceToArrival !== null && (body.bodyData.bodyId !== 0 || body.bodyData.distanceToArrival > 0)"
                            class="body-data-entry">
                            <div>
                                Distance to arrival
                            </div>
                            <div [matTooltip]="body.bodyData.distanceToArrival + ' ls'">
                                {{ body.bodyData.distanceToArrival | number:'0.2-2' }} ls
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Stellar Properties Section (Stars only) -->
                <ng-container
                    *ngIf="body.bodyData.type === 'Star' && (body.bodyData.luminosity || body.bodyData.absoluteMagnitude !== undefined || body.bodyData.spectralClass || getJetConeAngle() !== null)">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Stellar Properties</div>
                        <div *ngIf="body.bodyData.spectralClass" class="body-data-entry">
                            <div>
                                Spectral class
                            </div>
                            <div>
                                {{ body.bodyData.spectralClass }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.luminosity" class="body-data-entry">
                            <div>
                                Luminosity class
                            </div>
                            <div>
                                {{ body.bodyData.luminosity }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.absoluteMagnitude !== undefined && body.bodyData.absoluteMagnitude !== null"
                            class="body-data-entry">
                            <div>
                                Absolute magnitude
                            </div>
                            <div [matTooltip]="body.bodyData.absoluteMagnitude.toString()">
                                {{ body.bodyData.absoluteMagnitude | number:'0.2-2' }}
                            </div>
                        </div>
                        <div *ngIf="getJetConeAngle() !== null" class="body-data-entry">
                            <div>
                                Jet cone half angle
                            </div>
                            <div matTooltip="Estimate">
                                {{ getJetConeAngle() | number:'0.2-2' }}¬∞
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Resources Section (Rings/Belts) -->
                <ng-container
                    *ngIf="body.bodyData.reserveLevel || (body.bodyData.type === 'Ring' && getSignalsCount() > 0)">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Resources</div>
                        <div *ngIf="body.bodyData.reserveLevel && body.bodyData.type !== 'Ring'"
                            class="body-data-entry">
                            <div>
                                Reserve level
                            </div>
                            <div>
                                {{ body.bodyData.reserveLevel }}
                            </div>
                        </div>
                        <ng-container *ngIf="body.bodyData.type === 'Ring'">
                            <div *ngFor="let hotspot of getHotspotsList(); trackBy: trackByHotspot"
                                class="body-data-entry">
                                <div [matTooltip]="hotspot.description">
                                    {{ hotspot.displayName }}
                                </div>
                                <div>
                                    {{ hotspot.count }}
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>

                <!-- Signals Section (Human and Other only) -->
                <ng-container *ngIf="humanSignalCount || otherSignalCount">
                    <div class="body-data-section">
                        <div class="body-data-section-header">
                            Signals
                            <img *ngIf="humanSignalCount" src="assets/icons/Human.png"
                                style="width: 20px; height: 20px; margin-left: 8px; vertical-align: middle;" />
                            <img *ngIf="otherSignalCount" src="assets/icons/Other.png"
                                style="width: 20px; height: 20px; margin-left: 8px; vertical-align: middle;" />
                        </div>
                        <div *ngIf="humanSignalCount" class="body-data-entry">
                            <div>
                                Human
                            </div>
                            <div>
                                {{ humanSignalCount }}
                            </div>
                        </div>
                        <div *ngIf="otherSignalCount" class="body-data-entry">
                            <div>
                                Other
                            </div>
                            <div>
                                {{ otherSignalCount }}
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Geology Section -->
                <ng-container *ngIf="geologySignals.length || geologySignalCount">
                    <div class="body-data-section">
                        <div class="body-data-section-header">
                            Geology
                            <img src="assets/icons/Geology.png"
                                style="width: 20px; height: 20px; margin-left: 8px; vertical-align: middle;" />
                        </div>
                        <div class="body-data-entry">
                            <div>
                                Total Signals
                            </div>
                            <div>
                                {{ geologySignals.length }}/{{ geologySignalCount || 0 }}
                            </div>
                        </div>
                        <ng-container *ngIf="geologySignals.length">
                            <div *ngFor="let geologySignal of geologySignals" class="body-data-entry">
                                <div>
                                    {{ geologySignal }}
                                </div>
                                <div></div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>

                <!-- Biology Section -->
                <ng-container *ngIf="biologySignals.length || biologySignalCount">
                    <div class="body-data-section">
                        <div class="body-data-section-header">
                            Biology
                            <img src="assets/icons/Biology.png"
                                style="width: 20px; height: 20px; margin-left: 8px; vertical-align: middle;" />
                        </div>
                        <div class="body-data-entry">
                            <div>
                                Total Signals
                            </div>
                            <div>
                                {{ getConfirmedBiologyCount() }}/{{ biologySignalCount || 0 }}
                            </div>
                        </div>
                        <ng-container *ngIf="biologySignals.length">
                            <div *ngFor="let biologySignal of biologySignals" class="body-data-entry">
                                <div>
                                    <fa-icon *ngIf="biologySignal.isGuess" [icon]="faCircleQuestion"
                                        matTooltip="Guess"></fa-icon>
                                    <span *ngIf="!biologySignal.entryId">
                                        {{ biologySignal.signal }}</span>
                                    <span *ngIf="biologySignal.entryId">
                                        <a href="https://canonn-science.github.io/bioforge/?entryid={{ biologySignal.signal }}"
                                            target="_blank" rel="noopener noreferrer">
                                            {{ biologySignal.signal }}
                                            <fa-icon [icon]="faUpRightFromSquare"></fa-icon>
                                        </a>
                                    </span>
                                </div>
                                <div>
                                    <span *ngIf="biologySignal.codex?.reward">{{ biologySignal.codex?.reward |
                                        number }}
                                        cr</span>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>

                <!-- Thargoid Section -->
                <ng-container *ngIf="thargoidSignals.length || thargoidSignalCount">
                    <div class="body-data-section">
                        <div class="body-data-section-header">
                            Thargoid
                            <img src="assets/icons/Thargoid.png"
                                style="width: 20px; height: 20px; margin-left: 8px; vertical-align: middle;" />
                        </div>
                        <div class="body-data-entry">
                            <div>
                                Total Signals
                            </div>
                            <div>
                                {{ thargoidSignals.length }}/{{ thargoidSignalCount || 0 }}
                            </div>
                        </div>
                        <ng-container *ngIf="thargoidSignals.length">
                            <div *ngFor="let thargoidSignal of thargoidSignals" class="body-data-entry">
                                <div>
                                    {{ thargoidSignal }}
                                </div>
                                <div></div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>

                <!-- Guardian Section -->
                <ng-container *ngIf="guardianSignals.length || guardianSignalCount">
                    <div class="body-data-section">
                        <div class="body-data-section-header">
                            Guardian
                            <img src="assets/icons/Guardian.png"
                                style="width: 20px; height: 20px; margin-left: 8px; vertical-align: middle;" />
                        </div>
                        <div class="body-data-entry">
                            <div>
                                Total Signals
                            </div>
                            <div>
                                {{ guardianSignals.length }}/{{ guardianSignalCount || 0 }}
                            </div>
                        </div>
                        <ng-container *ngIf="guardianSignals.length">
                            <div *ngFor="let guardianSignal of guardianSignals" class="body-data-entry">
                                <div>
                                    {{ guardianSignal }}
                                </div>
                                <div></div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>
            </div>
        </div>
    </div>
    <div class="system-body-end"></div>
    <div class="child-bodies">
        <app-system-body *ngFor="let body of body.subBodies; last as isLast" [body]="body" [isLast]="isLast"
            [forceExpanded]="forceExpanded"></app-system-body>
    </div>
</div>

<ng-template #hillLimitDialogTemplate>
    <div class="hill-limit-dialog" *ngIf="hillLimitDialogData">
        <h2 mat-dialog-title>Shepherding Moon Analysis</h2>
        <mat-dialog-content>
            <p class="intro">
                This analysis evaluates whether this moon could act as a "shepherd moon" - a small satellite that helps
                maintain or shape the parent body's ring system through gravitational interactions.
            </p>
            <p class="intro">
                The Hill sphere represents the region around the moon where its gravity dominates. If this sphere
                extends close to or overlaps with the ring system, the moon could influence ring particle orbits.
            </p>

            <div class="chart-container">
                <div *ngIf="isChartLoading" class="chart-loading">
                    <p>Generating visualization...</p>
                </div>
                <canvas width="700" height="500"></canvas>
            </div>

            <div class="values">
                <p><strong>Analysis Results</strong></p>

                <ul>
                    <li><strong>Moon name:</strong> {{ hillLimitDialogData.bodyName }}</li>
                    <li><strong>Parent body:</strong> {{ hillLimitDialogData.parentName }}</li>
                    <li><strong>Moon orbital radius:</strong> {{
                        hillLimitDialogData.bodyOrbitalRadius.toLocaleString('en-US', {minimumFractionDigits: 0,
                        maximumFractionDigits: 0})
                        }} km</li>
                    <li><strong>Moon periapsis:</strong> {{
                        hillLimitDialogData.bodyPeriapsis.toLocaleString('en-US', {minimumFractionDigits: 0,
                        maximumFractionDigits: 0})
                        }} km</li>
                    <li><strong>Moon apoapsis:</strong> {{
                        hillLimitDialogData.bodyApoapsis.toLocaleString('en-US', {minimumFractionDigits: 0,
                        maximumFractionDigits: 0})
                        }} km</li>
                    <li><strong>Hill sphere radius:</strong> {{
                        hillLimitDialogData.hillRadius.toLocaleString('en-US', {minimumFractionDigits: 0,
                        maximumFractionDigits: 0})
                        }} km</li>
                    <li><strong>Outermost ring:</strong> {{
                        hillLimitDialogData.outermostRingRadius.toLocaleString('en-US', {minimumFractionDigits: 0,
                        maximumFractionDigits: 0})
                        }} km</li>
                </ul>


                <p><strong>Shepherding Analysis:</strong></p>
                <div class="conclusion">
                    <ng-container [ngSwitch]="hillLimitDialogData.shepherdStatus">
                        <div *ngSwitchCase="'shepherd'">
                            <strong>Status:</strong> <span style="color: #4dabf7;">Shepherd Moon</span><br>
                            The moon's Hill sphere (<strong>{{ hillLimitDialogData.hillRadius.toLocaleString('en-US',
                                {minimumFractionDigits: 0, maximumFractionDigits: 0}) }} km</strong> radius) extends
                            close enough to the ring system to potentially confine or shape the outer edge of the rings.
                            Its gravity likely influences ring particle orbits through direct gravitational interaction
                            or resonances.
                        </div>
                        <div *ngSwitchCase="'inner'">
                            <strong>Status:</strong> <span style="color: #51cf66;">Inner Moon (not a
                                shepherd)</span><br>
                            This moon orbits within the ring system but is too far from the ring edge for its Hill
                            sphere to influence the rings. It is not considered a shepherd moon.
                        </div>
                        <div *ngSwitchCase="'none'">
                            <strong>Status:</strong> <span style="color: #aaa;">Not a Shepherd</span><br>
                            The moon's Hill sphere (<strong>{{ hillLimitDialogData.hillRadius.toLocaleString('en-US',
                                {minimumFractionDigits: 0, maximumFractionDigits: 0}) }} km</strong> radius) is too far
                            from the ring system to have any shepherding effect.
                        </div>
                    </ng-container>
                </div>
            </div>

            <div class="disclaimer">
                <p><strong>Note:</strong> This is a simplified analysis focusing on the local gravitational environment.
                    Actual shepherding effects depend on many factors including orbital resonances, ring particle size
                    distribution, and long-term dynamical evolution.</p>
            </div>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Close</button>
        </mat-dialog-actions>
    </div>
</ng-template>

<ng-template #invisibleRingDialogTemplate>
    <div class="invisible-ring-dialog">
        <h2 mat-dialog-title>Invisible Ring Explanation</h2>
        <mat-dialog-content>
            <p class="intro">
                The "Invisible" badge indicates that this ring may not be visible in-game due to extremely low density.
                This calculation is based on data collected in the Canonn Ring survey.
            </p>

            <div class="formula">
                <strong>Calculation:</strong>
            </div>

            <div class="parameters">
                <p>A ring is considered potentially invisible when:</p>
                <ul>
                    <li><strong>Density</strong> &lt; 0.1 Mt/km¬≤</li>
                    <li><strong>AND</strong></li>
                    <li><strong>Ring width</strong> &gt; 1,000,000 km</li>
                </ul>
            </div>

            <div class="values" *ngIf="invisibleRingDialogData">
                <p><strong>Values for this ring:</strong></p>
                <ul>
                    <li><strong>Ring name:</strong> {{ invisibleRingDialogData.ringName }}</li>
                    <li><strong>Inner radius:</strong> {{ invisibleRingDialogData.innerRadius.toLocaleString() }} km
                    </li>
                    <li><strong>Outer radius:</strong> {{ invisibleRingDialogData.outerRadius.toLocaleString() }} km
                    </li>
                    <li><strong>Ring width:</strong> {{ invisibleRingDialogData.width.toLocaleString() }} km</li>
                    <li><strong>Ring area:</strong> {{ invisibleRingDialogData.area.toLocaleString() }} km¬≤</li>
                    <li><strong>Ring mass:</strong> {{ invisibleRingDialogData.mass.toLocaleString() }} Mt</li>
                    <li><strong>Density:</strong> {{ invisibleRingDialogData.density.toFixed(6) }} Mt/km¬≤</li>
                </ul>
            </div>

            <div class="result" *ngIf="invisibleRingDialogData">
                <p><strong>Analysis:</strong></p>
                <p *ngIf="invisibleRingDialogData.isInvisible" class="conclusion">
                    This ring meets both criteria (density &lt; 0.1 Mt/km¬≤ and width &gt; 1,000,000 km) and is likely
                    invisible in-game. The extremely low density means there is insufficient material to scatter light
                    and create a visible ring structure.
                </p>
                <p *ngIf="!invisibleRingDialogData.isInvisible" class="conclusion-safe">
                    This ring does not meet the invisibility criteria and should be visible in-game.
                </p>
            </div>

            <p class="disclaimer">
                <strong>Disclaimer:</strong> Ring visibility in Elite Dangerous depends on multiple factors including
                camera position, lighting conditions, and game rendering settings. This calculation provides only an
                estimate based on density and size.

                There may be some inaccuracies in this determination due to loss of precision in
                the database compared to ship logs. The values stored in the database may have been rounded or truncated
                during data collection.

            </p>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Close</button>
        </mat-dialog-actions>
    </div>
</ng-template>

<ng-template #jsonDialogTemplate>
    <div class="json-dialog">
        <h2 mat-dialog-title #jsonDialogTitle tabindex="-1">Body JSON Data</h2>
        <mat-dialog-content class="json-dialog-content">
            <pre>{{ getFormattedBodyJson() }}</pre>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Close</button>
            <button mat-button (click)="copyBodyJson()">Copy to Clipboard</button>
        </mat-dialog-actions>
    </div>
</ng-template>

<ng-template #rocheLimitDialogTemplate>
    <div class="roche-dialog" *ngIf="rocheLimitDialogData">
        <h2 mat-dialog-title>Roche Limit Analysis<span *ngIf="!rocheLimitDialogData.isBody"> - {{
                rocheLimitDialogData.parentName }}</span> - {{
            rocheLimitDialogData.ringName }}</h2>
        <mat-dialog-content>
            <div class="chart-description">
                <p>
                    This chart shows the relationship between particle density and Roche limit distance.
                    The Roche limit is the distance within which tidal forces would disintegrate a satellite.
                </p>
                <ul>
                    <li><strong>Rigid limit</strong> (1.26 coefficient): for solid bodies held together by internal
                        strength</li>
                    <li><strong>Fluid limit</strong> (2.456 coefficient): for liquid or loosely bound bodies</li>
                </ul>
            </div>

            <div class="chart-container">
                <div *ngIf="isChartLoading" class="chart-loading">
                    <div class="spinner"></div>
                    <p>Generating chart...</p>
                </div>
                <canvas #rocheCanvas width="700" height="400"></canvas>
            </div>

            <div class="ring-summary">
                <h3>Ring Positions</h3>
                <div *ngFor="let ring of rocheLimitDialogData.rings" class="ring-entry">
                    <strong>{{ ring.name }}</strong> ({{ ring.type }})
                    <br>
                    Position: {{ ring.innerRadius | number:'0.0-0' }} - {{ ring.outerRadius | number:'0.0-0' }} km
                    <br>
                    Assumed density: {{ ring.density }} kg/m¬≥
                </div>
            </div>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Close</button>
        </mat-dialog-actions>
    </div>
</ng-template>

<ng-template #tidalLockDialogTemplate>
    <div class="tidal-lock-dialog">
        <h2 mat-dialog-title>Tidal Locking & Synchronous Rotation</h2>
        <mat-dialog-content>
            <ng-container
                *ngIf="tidalLockDialogData.resonance === '1:1' && tidalLockDialogData.solarDay !== null && abs(tidalLockDialogData.solarDay) > 1000; else notLocked">
                <p class="intro">
                    This body is <strong>synchronous</strong> (tidally locked): its rotational period matches its
                    orbital period, so the same face always points toward its parent body.
                </p>
            </ng-container>
            <ng-template #notLocked>
                <p class="intro">
                    This body is <strong>not tidally locked</strong>.
                    <span *ngIf="tidalLockDialogData.resonance !== '1:1' && tidalLockDialogData.resonance !== 'none'">
                        It is in a <strong>{{ tidalLockDialogData.resonance }}</strong> spin resonance, meaning it
                        rotates {{ tidalLockDialogData.resonance.split(':')[0] }} times for every {{
                        tidalLockDialogData.resonance.split(':')[1] }} orbits.
                    </span>
                    <span *ngIf="tidalLockDialogData.solarDay !== null && abs(tidalLockDialogData.solarDay) < 1000">
                        The solar day (the time between successive sunrises) is {{ tidalLockDialogData.solarDay |
                        number:'0.2-2' }} days, so the same face does not always point at the parent body.
                    </span>
                </p>
            </ng-template>
            <ul>
                <li><strong>Rotational period:</strong> {{ tidalLockDialogData.rotationalPeriod | number:'0.2-2' }} days
                </li>
                <li><strong>Orbital period:</strong> {{ tidalLockDialogData.orbitalPeriod | number:'0.2-2' }} days</li>
                <li *ngIf="tidalLockDialogData.solarDay !== null"><strong>Solar day:</strong> {{
                    tidalLockDialogData.solarDay | number:'0.2-2' }} days</li>
                <li *ngIf="tidalLockDialogData.difference !== null"><strong>Difference:</strong> {{
                    tidalLockDialogData.difference | number:'0.4-4' }} days</li>
                <li *ngIf="tidalLockDialogData.resonance && tidalLockDialogData.resonance !== 'none'"><strong>Spin
                        resonance:</strong> {{ tidalLockDialogData.resonance }}</li>
            </ul>
            <p class="disclaimer" style="color: #b8860b; font-style: italic; margin-bottom: 0.5em;">
                <strong>Disclaimer:</strong> This tidal locking analysis feature is still being refined. It is currently
                unclear why the game journal sets the tidal locking flag for some bodies that are not truly tidally
                locked. The analysis here may differ from the in-game flag.
            </p>
            <p class="explanation">
                <strong>How is this determined?</strong><br>
                <u>Sidereal day:</u> The sidereal day is the time it takes for a body to rotate once relative to the
                distant stars. This is equal to the rotational period shown above.<br>
                <u>Solar day:</u> The solar day is the time between successive sunrises for an observer on the surface.
                It is calculated as:
                <br>
                <code>solarDay = 1 / |1/rotationalPeriod - 1/orbitalPeriod|</code>
                <br>
                If the rotational and orbital periods are exactly equal (1:1 resonance), the solar day is infinite‚Äîthe
                sun never moves in the sky, and the same face always points at the parent body.<br>
                If the resonance is not 1:1 or the solar day is short, the body is not tidally locked, even if the game
                says so.<br>
                <u>Axial tilt:</u> Even on a tidally locked world, if the planet has a significant axial tilt, some
                regions may experience a day/night cycle as the star appears to move north and south in the sky over the
                course of an orbit. This can create areas with periodic sunlight and darkness despite tidal locking.
            </p>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Close</button>
        </mat-dialog-actions>
    </div>
</ng-template>