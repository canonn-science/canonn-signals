<div class="body-container" [ngClass]="styleClass">
    <div class="body-title">
        <div class="title-left">
            <b>{{ body.bodyData.name }}</b>
            <span *ngIf="body.bodyData.subType">-</span>
            <span *ngIf="body.bodyData.subType" [matTooltip]="getSolidCompositionTooltip()"
                matTooltipClass="multiline-tooltip">{{ body.bodyData.subType }}</span>
            <span *ngIf="classifyNeutronStar()"
                [class]="classifyNeutronStar()!.classification === 'Anomalous' ? 'badge badge-red' : 'neutron-star-classification'"
                [matTooltip]="classifyNeutronStar()!.tooltip">{{ classifyNeutronStar()!.classification === 'Anomalous' ?
                classifyNeutronStar()!.classification : '- ' + classifyNeutronStar()!.classification }}</span>
            <span *ngIf="body.bodyData.atmosphereType || body.bodyData.atmosphereComposition"
                [matTooltip]="getAtmosphereCompositionTooltip()" matTooltipClass="multiline-tooltip"
                class="atmosphere-type">
                - {{ getAtmosphereDisplay() }}
            </span>
            <span *ngIf="isRingNotVisible()" class="badge badge-red clickable"
                (click)="showInvisibleRingExplanation()">Invisible</span>
            <span *ngIf="getHillLimitExceeded()" class="badge badge-red clickable"
                [matTooltip]="'Hill limit exceeded by ' + (getHillLimitExceeded()! | number:'0.0-0') + ' km'"
                (click)="showHillLimitExplanation()">Anomalous</span>
            <span *ngIf="body.bodyData.isLandable" [class]="'badge ' + getLandableBadgeClass()"
                [matTooltip]="getLandableTooltip()">
                <img src="assets/icons/footprint.svg" style="width: 12px; height: 12px; filter: brightness(0);" />
            </span>
            <span *ngIf="getSpinResonance() !== 'none' || body.bodyData.rotationalPeriodTidallyLocked"
                class="badge badge-purple" [matTooltip]="getSpinResonanceTooltip()">
                <span *ngIf="getSpinResonance() !== 'none'">{{ getSpinResonance() }}</span><fa-icon
                    *ngIf="body.bodyData.rotationalPeriodTidallyLocked" [icon]="faLock" class="lock-icon"></fa-icon>
            </span>
            <span
                *ngIf="body.bodyData.isLandable &&  body.bodyData.atmosphereType && body.bodyData.atmosphereType != ''"
                class="badge badge-blue">Odyssey</span>
            <span *ngIf="body.bodyData.terraformingState == 'Terraformable'"
                class="badge badge-gray">Terraformable</span>
            <span *ngIf="trojanStatus" class="badge badge-blue" [matTooltip]="'Trojan at Lagrange ' + trojanStatus">{{
                trojanStatus }}</span>
            <span *ngIf="rosetteStatus" class="badge badge-red" [matTooltip]="'Klemperer ' + rosetteStatus">{{
                rosetteStatus }}</span>
            <span *ngIf="getRocheExcess()" class="badge badge-red"
                [matTooltip]="'Roche limit exceeded by ' + (getRocheExcess()! | number:'0.0-0') + ' km'">
                <img src="assets/icons/roche.svg" style="width: 12px; height: 12px; filter: brightness(0);" />
            </span>
            <div *ngIf="geologySignals.length || geologySignalCount" matTooltip="Geological signals">
                <img src="assets/icons/Geology.png" />
            </div>
            <div *ngIf="biologySignals.length || biologySignalCount" matTooltip="Biological signals">
                <img src="assets/icons/Biology.png" />
            </div>
            <div *ngIf="thargoidSignals.length || thargoidSignalCount" matTooltip="Thargoid signals">
                <img src="assets/icons/Thargoid.png" />
            </div>
            <div *ngIf="guardianSignals.length || guardianSignalCount" matTooltip="Guardian signals">
                <img src="assets/icons/Guardian.png" />
            </div>
            <div *ngIf="exandable && !expanded" (click)="toggleExpand()" class="clickable" matTooltip="Expand">
                <fa-icon [icon]="faSquareCaretDown"></fa-icon>
            </div>
            <div *ngIf="exandable && expanded" (click)="toggleExpand()" class="clickable" matTooltip="Collapse">
                <fa-icon [icon]="faSquareCaretUp"></fa-icon>
            </div>
            <div *ngIf="hasChildren() && getChildrenExpandedState()" (click)="toggleChildren()" class="clickable"
                matTooltip="Collapse all children">
                <fa-icon [icon]="faSquareCaretUp"></fa-icon>
            </div>
            <div *ngIf="hasChildren() && !getChildrenExpandedState()" (click)="toggleChildren()" class="clickable"
                matTooltip="Expand all children">
                <fa-icon [icon]="faSquareCaretDown"></fa-icon>
            </div>
        </div>
        <div class="materials-badges" (mouseleave)="hoveredIndex = -1">
            <span *ngFor="let material of getMaterialBadges(); let i = index" [class]="'badge ' + material.class"
                (mouseenter)="onMouseEnter(i)">{{ hoveredIndex === i ? material.tooltip : material.name }}</span>
            <button class="json-button" (click)="showBodyJsonDialog($event)"
                (contextmenu)="copyBodyJson(); $event.preventDefault()"
                matTooltip="View body JSON (right-click to copy)">
                <fa-icon [icon]="faCode"></fa-icon>
            </button>
        </div>
    </div>
    <div class="system-body" *ngIf="isExpanded" [@grow]>
        <div class="body-image">
            <img *ngIf="bodyCoronaImage" src="assets/{{ bodyCoronaImage }}" class="body-image-corona"
                (error)="bodyCoronaImage = ''" loading="lazy" />
            <img *ngIf="bodyImage" src="assets/{{ bodyImage }}" (error)="bodyImage = ''" loading="lazy" />
        </div>
        <div class="body-content">
            <div class="body-data-columns">
                <!-- Orbit Section -->
                <ng-container
                    *ngIf="body.bodyData.orbitalPeriod || body.bodyData.semiMajorAxis || body.bodyData.orbitalEccentricity !== undefined || body.bodyData.orbitalInclination || body.bodyData.argOfPeriapsis || body.bodyData.ascendingNode || getNextPeriapsis() || getNextApoapsis()">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Orbit</div>
                        <div *ngIf="body.bodyData.orbitalPeriod" class="body-data-entry">
                            <div>
                                Orbital period
                            </div>
                            <div [matTooltip]="body.bodyData.orbitalPeriod + ' days'">
                                {{ body.bodyData.orbitalPeriod | number:'0.2-2' }} days
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.semiMajorAxis" class="body-data-entry">
                            <div>
                                Semi-major axis
                            </div>
                            <div [matTooltip]="body.bodyData.semiMajorAxis + ' au'">
                                {{ (body.bodyData.semiMajorAxis * 149597870.7) | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.orbitalEccentricity !== undefined && body.bodyData.orbitalEccentricity !== null"
                            class="body-data-entry">
                            <div>
                                Orbital eccentricity
                            </div>
                            <div [matTooltip]="body.bodyData.orbitalEccentricity.toString()">
                                {{ body.bodyData.orbitalEccentricity | number:'0.4-4' }} {{
                                getEccentricityAnalysis(body.bodyData.orbitalEccentricity) }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.semiMajorAxis && body.bodyData.orbitalEccentricity !== undefined && body.bodyData.orbitalEccentricity !== null && body.bodyData.orbitalEccentricity !== 0"
                            class="body-data-entry">
                            <div>
                                Apoapsis
                            </div>
                            <div [matTooltip]="getApoapsis() + ' km'">
                                {{ getApoapsis() | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="getNextApoapsis()" class="body-data-entry">
                            <div>
                                Next apoapsis
                            </div>
                            <div>
                                {{ getNextApoapsis()!.date | date:'yyyy-MM-dd HH:mm' }} ({{ getNextApoapsis()!.days |
                                number:'0.1-1' }} days)
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.semiMajorAxis && body.bodyData.orbitalEccentricity !== undefined && body.bodyData.orbitalEccentricity !== null && body.bodyData.orbitalEccentricity !== 0"
                            class="body-data-entry">
                            <div>
                                Periapsis
                            </div>
                            <div [matTooltip]="getPeriapsis() + ' km'">
                                {{ getPeriapsis() | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="getNextPeriapsis()" class="body-data-entry">
                            <div>
                                Next periapsis
                            </div>
                            <div>
                                {{ getNextPeriapsis()!.date | date:'yyyy-MM-dd HH:mm' }} ({{ getNextPeriapsis()!.days |
                                number:'0.1-1' }} days)
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.orbitalInclination" class="body-data-entry">
                            <div>
                                Orbital inclination
                            </div>
                            <div [matTooltip]="body.bodyData.orbitalInclination + '°'">
                                {{ body.bodyData.orbitalInclination | number:'0.2-2' }}°
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.argOfPeriapsis" class="body-data-entry">
                            <div>
                                Argument of periapsis
                            </div>
                            <div [matTooltip]="body.bodyData.argOfPeriapsis + '°'">
                                {{ body.bodyData.argOfPeriapsis | number:'0.2-2' }}°
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.ascendingNode" class="body-data-entry">
                            <div>
                                Ascending node
                            </div>
                            <div [matTooltip]="body.bodyData.ascendingNode + '°'">
                                {{ body.bodyData.ascendingNode | number:'0.2-2' }}°
                            </div>
                        </div>
                        <div *ngIf="getTangentialVelocity() !== null" class="body-data-entry">
                            <div>
                                Tangential velocity
                            </div>
                            <div [matTooltip]="getTangentialVelocityTooltip()">
                                {{ getTangentialVelocityDisplay() }}
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Physical Properties Section -->
                <ng-container
                    *ngIf="body.bodyData.radius || body.bodyData.earthMasses || body.bodyData.solarMasses || body.bodyData.solarRadius || body.bodyData.gravity || body.bodyData.axialTilt || body.bodyData.age || body.bodyData.mass || (body.bodyData.innerRadius && body.bodyData.outerRadius)">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Physical Properties</div>
                        <div *ngIf="body.bodyData.radius" class="body-data-entry">
                            <div>
                                Radius
                            </div>
                            <div [matTooltip]="body.bodyData.radius + ' km'">
                                {{ body.bodyData.radius | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.solarRadius" class="body-data-entry">
                            <div>
                                Solar radius
                            </div>
                            <div [matTooltip]="body.bodyData.solarRadius.toString()">
                                {{ body.bodyData.solarRadius | number:'0.2-2' }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.earthMasses && body.bodyData.type === 'Planet'"
                            class="body-data-entry">
                            <div>
                                Mass
                            </div>
                            <div [matTooltip]="formattedEarthMass?.tooltip || ''">
                                {{ formattedEarthMass?.display }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.solarMasses" class="body-data-entry">
                            <div>
                                Solar masses
                            </div>
                            <div [matTooltip]="formattedSolarMass?.tooltip || ''">
                                {{ formattedSolarMass?.display }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.mass" class="body-data-entry">
                            <div>
                                Mass
                            </div>
                            <div [matTooltip]="body.bodyData.mass + ' Mt'">
                                {{ body.bodyData.mass | number:'0.2-2' }} Mt
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.gravity" class="body-data-entry">
                            <div>
                                Gravity
                            </div>
                            <div [matTooltip]="body.bodyData.gravity + ' G'">
                                {{ body.bodyData.gravity | number:'0.2-2' }} G
                            </div>
                        </div>
                        <div *ngIf="getPlanetaryDensity()" class="body-data-entry">
                            <div>
                                Density
                            </div>
                            <div [matTooltip]="getPlanetaryDensity()!.tooltip">
                                {{ getPlanetaryDensity()!.value | number:'0.2-2' }} {{ getPlanetaryDensity()!.unit }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.axialTilt" class="body-data-entry">
                            <div>
                                Axial tilt
                            </div>
                            <div [matTooltip]="body.bodyData.axialTilt + '°'">
                                {{ body.bodyData.axialTilt | number:'0.2-2' }}°
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.age" class="body-data-entry">
                            <div>
                                Age
                            </div>
                            <div>
                                {{ body.bodyData.age }} million years
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.innerRadius" class="body-data-entry">
                            <div>
                                Inner radius
                            </div>
                            <div [matTooltip]="body.bodyData.innerRadius + ' km'">
                                {{ body.bodyData.innerRadius | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.outerRadius" class="body-data-entry">
                            <div>
                                Outer radius
                            </div>
                            <div [matTooltip]="body.bodyData.outerRadius + ' km'">
                                {{ body.bodyData.outerRadius | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.innerRadius && body.bodyData.outerRadius" class="body-data-entry">
                            <div>
                                Ring width
                            </div>
                            <div [matTooltip]="getRingWidth() + ' km'">
                                {{ getRingWidth() | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.innerRadius && body.bodyData.outerRadius" class="body-data-entry">
                            <div>
                                Ring area
                            </div>
                            <div [matTooltip]="getRingArea() + ' km²'">
                                {{ getRingArea() | number:'0.2-2' }} km²
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.mass && body.bodyData.innerRadius && body.bodyData.outerRadius"
                            class="body-data-entry">
                            <div>
                                Density
                            </div>
                            <div [matTooltip]="getRingDensity() + ' Mt/km²'">
                                {{ getRingDensity() | number:'0.2-2' }} Mt/km²
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.type === 'Ring' && calculateHillLimit() !== null"
                            class="body-data-entry clickable" (click)="showHillLimitExplanation()">
                            <div>
                                Hill limit
                            </div>
                            <div [matTooltip]="calculateHillLimit()! + ' km'">
                                {{ calculateHillLimit()! | number:'0.2-2' }} km
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.type === 'Ring' && calculateHillLimit() === null"
                            class="body-data-entry"
                            [matTooltip]="'The Hill limit cannot be calculated because the data from Spansh is incomplete'">
                            <div>
                                Hill limit
                            </div>
                            <div>
                                n/a
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Atmosphere & Environment Section -->
                <ng-container
                    *ngIf="body.bodyData.surfaceTemperature || body.bodyData.surfacePressure || body.bodyData.volcanismType">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Atmosphere & Environment</div>
                        <div *ngIf="body.bodyData.surfaceTemperature" class="body-data-entry">
                            <div>
                                Surface temperature
                            </div>
                            <div [matTooltip]="body.bodyData.surfaceTemperature + ' K'">
                                {{ body.bodyData.surfaceTemperature | number:'0.2-2' }} K
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.surfacePressure" class="body-data-entry">
                            <div>
                                Surface pressure
                            </div>
                            <div [matTooltip]="body.bodyData.surfacePressure + ' atmospheres'">
                                {{ body.bodyData.surfacePressure | number:'0.2-2' }} atmospheres
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.volcanismType" class="body-data-entry">
                            <div>
                                Volcanism
                            </div>
                            <div>
                                {{ body.bodyData.volcanismType }}
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Dynamics Section -->
                <ng-container *ngIf="body.bodyData.rotationalPeriod || body.bodyData.distanceToArrival !== undefined">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Dynamics</div>
                        <div *ngIf="body.bodyData.rotationalPeriod" class="body-data-entry">
                            <div>
                                Rotational period
                            </div>
                            <div [matTooltip]="body.bodyData.rotationalPeriod + ' days'">
                                {{ body.bodyData.rotationalPeriod | number:'0.2-2' }} days
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.distanceToArrival !== undefined && body.bodyData.distanceToArrival !== null && (body.bodyData.bodyId !== 0 || body.bodyData.distanceToArrival > 0)"
                            class="body-data-entry">
                            <div>
                                Distance to arrival
                            </div>
                            <div [matTooltip]="body.bodyData.distanceToArrival + ' ls'">
                                {{ body.bodyData.distanceToArrival | number:'0.2-2' }} ls
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Stellar Properties Section (Stars only) -->
                <ng-container
                    *ngIf="body.bodyData.type === 'Star' && (body.bodyData.luminosity || body.bodyData.absoluteMagnitude !== undefined || body.bodyData.spectralClass || getJetConeAngle() !== null)">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Stellar Properties</div>
                        <div *ngIf="body.bodyData.spectralClass" class="body-data-entry">
                            <div>
                                Spectral class
                            </div>
                            <div>
                                {{ body.bodyData.spectralClass }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.luminosity" class="body-data-entry">
                            <div>
                                Luminosity class
                            </div>
                            <div>
                                {{ body.bodyData.luminosity }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.absoluteMagnitude !== undefined && body.bodyData.absoluteMagnitude !== null"
                            class="body-data-entry">
                            <div>
                                Absolute magnitude
                            </div>
                            <div [matTooltip]="body.bodyData.absoluteMagnitude.toString()">
                                {{ body.bodyData.absoluteMagnitude | number:'0.2-2' }}
                            </div>
                        </div>
                        <div *ngIf="getJetConeAngle() !== null" class="body-data-entry">
                            <div>
                                Jet cone half angle
                            </div>
                            <div matTooltip="Estimate">
                                {{ getJetConeAngle() | number:'0.2-2' }}°
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Resources Section (Rings/Belts) -->
                <ng-container
                    *ngIf="body.bodyData.reserveLevel || (body.bodyData.type === 'Ring' && getSignalsCount() > 0)">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Resources</div>
                        <div *ngIf="body.bodyData.reserveLevel" class="body-data-entry">
                            <div>
                                Reserve level
                            </div>
                            <div>
                                {{ body.bodyData.reserveLevel }}
                            </div>
                        </div>
                        <div *ngIf="body.bodyData.type === 'Ring' && getSignalsCount() > 0" class="body-data-entry">
                            <div>
                                Hotspots
                            </div>
                            <div [matTooltip]="getSignalsTooltip()" matTooltipClass="multiline-tooltip">
                                {{ getSignalsCount() }} hotspot(s)
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- Signals Section -->
                <ng-container *ngIf="hasSignals">
                    <div class="body-data-section">
                        <div class="body-data-section-header">Signals</div>
                        <div *ngIf="humanSignalCount" class="body-signal">
                            <div class="body-signal-name">
                                <img src="assets/icons/Human.png" />
                                <span>
                                    Human: {{ humanSignalCount }}
                                </span>
                            </div>
                        </div>
                        <div *ngIf="otherSignalCount" class="body-signal">
                            <div class="body-signal-name">
                                <img src="assets/icons/Other.png" />
                                <span>
                                    Other: {{ otherSignalCount }}
                                </span>
                            </div>
                        </div>
                        <div *ngIf="geologySignals.length || geologySignalCount" class="body-signal">
                            <div class="body-signal-name">
                                <img src="assets/icons/Geology.png" />
                                <span>
                                    Geology: {{ geologySignalCount }}
                                </span>
                            </div>
                            <ng-container *ngIf="geologySignals.length">
                                <fa-icon [icon]="faChevronRight"></fa-icon>
                                <div>
                                    <div *ngFor="let geologySignal of geologySignals" class="body-signal-data">
                                        {{ geologySignal }}
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                        <div *ngIf="biologySignals.length || biologySignalCount" class="body-signal">
                            <div class="body-signal-name">
                                <img src="assets/icons/Biology.png" />
                                <span>
                                    Biology: {{ biologySignalCount }}
                                </span>
                            </div>
                            <ng-container *ngIf="biologySignals.length">
                                <fa-icon [icon]="faChevronRight"></fa-icon>
                                <div>
                                    <div *ngFor="let biologySignal of biologySignals" class="body-signal-data">
                                        <div>
                                            <fa-icon *ngIf="biologySignal.isGuess" [icon]="faCircleQuestion"
                                                matTooltip="Guess"></fa-icon>
                                            <span *ngIf="!biologySignal.entryId">
                                                {{ biologySignal.signal }}</span>
                                            <span *ngIf="biologySignal.entryId">
                                                <a
                                                    href="https://canonn-science.github.io/bioforge/?entryid={{ biologySignal.signal }}">
                                                    {{ biologySignal.signal }}
                                                </a>
                                                <fa-icon [icon]="faUpRightFromSquare"></fa-icon>
                                            </span>
                                        </div>
                                        <span *ngIf="biologySignal.codex?.reward">{{ biologySignal.codex?.reward |
                                            number }}
                                            cr</span>
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                        <div *ngIf="thargoidSignals.length || thargoidSignalCount" class="body-signal">
                            <div class="body-signal-name">
                                <img src="assets/icons/Thargoid.png" />
                                <span>
                                    Thargoid: {{ thargoidSignalCount }}
                                </span>
                            </div>
                            <ng-container *ngIf="thargoidSignals.length">
                                <fa-icon [icon]="faChevronRight"></fa-icon>
                                <div>
                                    <div *ngFor="let thargoidSignal of thargoidSignals" class="body-signal-data">
                                        {{ thargoidSignal }}
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                        <div *ngIf="guardianSignals.length || guardianSignalCount" class="body-signal">
                            <div class="body-signal-name">
                                <img src="assets/icons/Guardian.png" />
                                <span>
                                    Guardian: {{ guardianSignalCount }}
                                </span>
                            </div>
                            <ng-container *ngIf="guardianSignals.length">
                                <fa-icon [icon]="faChevronRight"></fa-icon>
                                <div>
                                    <div *ngFor="let guardianSignal of guardianSignals" class="body-signal-data">
                                        {{ guardianSignal }}
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                    </div>
                </ng-container>
            </div>
        </div>
    </div>
    <div class="system-body-end"></div>
    <div class="child-bodies">
        <app-system-body *ngFor="let body of body.subBodies; last as isLast" [body]="body" [isLast]="isLast"
            [forceExpanded]="forceExpanded"></app-system-body>
    </div>
</div>

<ng-template #hillLimitDialogTemplate>
    <div class="hill-limit-dialog">
        <h2 mat-dialog-title>Ring Stability Assessment (Hill Sphere Method)</h2>
        <mat-dialog-content>
            <p class="intro">
                This report evaluates whether the ring lies within the parent body's theoretically stable gravitational
                zone.
                Stability is determined by the effective Hill radius, which represents the outermost distance at which
                the parent
                body can retain orbiting material.
            </p>
            <p class="intro">
                Nearby bodies with significant gravitational influence can reduce this stable region far below the
                baseline Hill sphere.
            </p>

            <div class="values" *ngIf="hillLimitDialogData">
                <p><strong>System Overview</strong></p>

                <p><strong>Parent Body</strong></p>
                <ul>
                    <li><strong>Name:</strong> {{ hillLimitDialogData.parentBodyName }}</li>
                    <li><strong>Mass:</strong> {{ hillLimitDialogData.parentMass.toLocaleString('en-US',
                        {minimumFractionDigits: 6, maximumFractionDigits: 6}) }} Earth masses</li>
                </ul>

                <p><strong>Nearest Star</strong></p>
                <ul>
                    <li><strong>Name:</strong> {{ hillLimitDialogData.primaryStarName }}</li>
                    <li><strong>Mass:</strong> {{ hillLimitDialogData.primaryMass.toLocaleString('en-US',
                        {minimumFractionDigits: 6, maximumFractionDigits: 6}) }} Earth masses</li>
                </ul>
            </div>

            <div class="result" *ngIf="hillLimitDialogData">
                <p><strong>Hill Radius & Ring Stability Results</strong></p>
                <ul>
                    <li>
                        <strong>Baseline Hill Radius (star only):</strong> {{
                        hillLimitDialogData.baselineHillRadius.toLocaleString('en-US', {maximumFractionDigits: 0}) }} km
                    </li>
                    <li>
                        <strong>Effective Hill Radius (including nearby gravitational influences):</strong> {{
                        hillLimitDialogData.minHillRadius.toLocaleString('en-US', {maximumFractionDigits: 0}) }} km
                    </li>
                    <li>
                        <strong>Ring Outer Radius:</strong> {{ hillLimitDialogData.outerRadius.toLocaleString('en-US',
                        {maximumFractionDigits: 0}) }} km
                    </li>
                </ul>

                <div *ngIf="hillLimitDialogData.isExceeded"
                    style="margin-top: 15px; padding: 12px; background: #ff9999; border-radius: 4px; border-left: 4px solid #d32f2f; color: #1c1c1c;">
                    <p style="margin: 0;"><strong>Stability Verdict:</strong></p>
                    <p style="margin: 8px 0 0 0; font-size: 1.1em;"><strong>UNSTABLE</strong> — The ring extends {{
                        hillLimitDialogData.difference.toLocaleString('en-US', {maximumFractionDigits: 0}) }} km beyond
                        the effective Hill radius.</p>
                    <p style="margin: 8px 0 0 0; font-size: 0.95em;">Material at this distance cannot
                        remain in stable orbit around the parent body.</p>
                </div>
                <div *ngIf="!hillLimitDialogData.isExceeded"
                    style="margin-top: 15px; padding: 12px; background: #99cc99; border-radius: 4px; border-left: 4px solid #388e3c; color: #1c1c1c;">
                    <p style="margin: 0;"><strong>Stability Verdict:</strong></p>
                    <p style="margin: 8px 0 0 0; font-size: 1.1em;"><strong>STABLE</strong> — The ring is {{
                        hillLimitDialogData.difference.toLocaleString('en-US', {maximumFractionDigits: 0}) }} km inside
                        the effective Hill radius.</p>
                    <p style="margin: 8px 0 0 0; font-size: 0.95em;">The ring lies within the
                        gravitationally stable zone{{
                        hillLimitDialogData.perturbers && hillLimitDialogData.perturbers.length > 0 ? ', even accounting
                        for nearby perturbing bodies' : '' }}.</p>
                </div>
            </div>

            <div class="parameters"
                *ngIf="hillLimitDialogData?.perturbers && hillLimitDialogData.perturbers.length > 0">
                <p><strong>Nearby Bodies Affecting Gravitational Stability</strong></p>
                <p>
                    These are bodies within 3× the ring radius whose gravitational influence constrains the parent
                    body's stable zone.
                    The smallest resulting Hill radius among them defines the effective Hill limit.
                </p>
                <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #555;">
                            <th style="text-align: left; padding: 8px; font-weight: 600; color: #e0e0e0;">Nearby Body
                            </th>
                            <th style="text-align: right; padding: 8px; font-weight: 600; color: #e0e0e0;">Average
                                Distance (km)</th>
                            <th style="text-align: right; padding: 8px; font-weight: 600; color: #e0e0e0;">Local Hill
                                Radius (km)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let perturber of hillLimitDialogData.perturbers"
                            [style.background]="perturber.name === hillLimitDialogData.limitingPerturber ? '#3a3a2a' : 'transparent'"
                            style="border-bottom: 1px solid #444;">
                            <td style="padding: 8px; color: #e0e0e0;">{{ perturber.name }}</td>
                            <td style="text-align: right; padding: 8px; color: #e0e0e0;">{{
                                perturber.minDistance.toLocaleString('en-US', {maximumFractionDigits: 0}) }}</td>
                            <td style="text-align: right; padding: 8px; color: #e0e0e0;">{{
                                perturber.hillRadius.toLocaleString('en-US',
                                {maximumFractionDigits: 0}) }}</td>
                        </tr>
                    </tbody>
                </table>
                <div *ngIf="hillLimitDialogData.limitingPerturber"
                    style="margin-top: 12px; padding: 10px; background: #2a2a2a; border-radius: 4px; border-left: 4px solid #ffcc33;">
                    <p style="margin: 0; color: #e0e0e0;"><strong>Dominant Stability-Limiting Body:</strong></p>
                    <p style="margin: 5px 0 0 0; color: #ffcc33;"><strong>{{ hillLimitDialogData.limitingPerturber
                            }}</strong></p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #b0b0b0;">
                        Its proximity restricts the stability zone to {{
                        hillLimitDialogData.minHillRadius.toLocaleString('en-US', {maximumFractionDigits: 0}) }} km{{
                        hillLimitDialogData.isExceeded ? ', far inside the ring' : '' }}.
                    </p>
                </div>
            </div>

            <div class="formula">
                <strong>Calculation Method:</strong>


                <div class="parameters">
                    <p>
                        The algorithm samples orbital positions accounting for eccentricity, inclination, argument of
                        periapsis, and ascending node. For each potential perturber within range, it computes the Hill
                        radius at average separation: r<sub>H</sub> = d × (m / (3 × M))<sup>1/3</sup>, where d is the
                        average distance
                        to the perturber, m is the parent mass, and M is the perturber mass. The smallest computed Hill
                        radius defines the
                        effective stability limit.
                    </p>
                </div>
            </div>

            <div class="disclaimer">
                <p><strong>Note:</strong> The method used for calculating the absolute positions of the stars is not yet
                    perfect but is a good approximation. The more parent-child relationships in a chain, the less
                    accurate the positions.</p>
            </div>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Close</button>
        </mat-dialog-actions>
    </div>
</ng-template>

<ng-template #invisibleRingDialogTemplate>
    <div class="invisible-ring-dialog">
        <h2 mat-dialog-title>Invisible Ring Explanation</h2>
        <mat-dialog-content>
            <p class="intro">
                The "Invisible" badge indicates that this ring may not be visible in-game due to extremely low density.
                This calculation is based on data collected in the Canonn Ring survey.
            </p>

            <div class="formula">
                <strong>Calculation:</strong>
            </div>

            <div class="parameters">
                <p>A ring is considered potentially invisible when:</p>
                <ul>
                    <li><strong>Density</strong> &lt; 0.1 Mt/km²</li>
                    <li><strong>AND</strong></li>
                    <li><strong>Ring width</strong> &gt; 1,000,000 km</li>
                </ul>
            </div>

            <div class="values" *ngIf="invisibleRingDialogData">
                <p><strong>Values for this ring:</strong></p>
                <ul>
                    <li><strong>Ring name:</strong> {{ invisibleRingDialogData.ringName }}</li>
                    <li><strong>Inner radius:</strong> {{ invisibleRingDialogData.innerRadius.toLocaleString() }} km
                    </li>
                    <li><strong>Outer radius:</strong> {{ invisibleRingDialogData.outerRadius.toLocaleString() }} km
                    </li>
                    <li><strong>Ring width:</strong> {{ invisibleRingDialogData.width.toLocaleString() }} km</li>
                    <li><strong>Ring area:</strong> {{ invisibleRingDialogData.area.toLocaleString() }} km²</li>
                    <li><strong>Ring mass:</strong> {{ invisibleRingDialogData.mass.toLocaleString() }} Mt</li>
                    <li><strong>Density:</strong> {{ invisibleRingDialogData.density.toFixed(6) }} Mt/km²</li>
                </ul>
            </div>

            <div class="result" *ngIf="invisibleRingDialogData">
                <p><strong>Analysis:</strong></p>
                <p *ngIf="invisibleRingDialogData.isInvisible" class="conclusion">
                    This ring meets both criteria (density &lt; 0.1 Mt/km² and width &gt; 1,000,000 km) and is likely
                    invisible in-game. The extremely low density means there is insufficient material to scatter light
                    and create a visible ring structure.
                </p>
                <p *ngIf="!invisibleRingDialogData.isInvisible" class="conclusion-safe">
                    This ring does not meet the invisibility criteria and should be visible in-game.
                </p>
            </div>

            <p class="disclaimer">
                <strong>Disclaimer:</strong> Ring visibility in Elite Dangerous depends on multiple factors including
                camera position, lighting conditions, and game rendering settings. This calculation provides only an
                estimate based on density and size.

                There may be some inaccuracies in this determination due to loss of precision in
                the database compared to ship logs. The values stored in the database may have been rounded or truncated
                during data collection.

            </p>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Close</button>
        </mat-dialog-actions>
    </div>
</ng-template>

<ng-template #jsonDialogTemplate>
    <div class="json-dialog">
        <h2 mat-dialog-title>Body JSON Data</h2>
        <mat-dialog-content>
            <pre>{{ getFormattedBodyJson() }}</pre>
        </mat-dialog-content>
        <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>Close</button>
            <button mat-button (click)="copyBodyJson()">Copy to Clipboard</button>
        </mat-dialog-actions>
    </div>
</ng-template>